@page "/login"
@inject HttpClient Http
@inject IConfiguration Configuration
@inject IJSRuntime JSRuntime
@using Emne9_Prosjekt.Features.Members.Models
@using Microsoft.Extensions.Configuration
@using Microsoft.JSInterop

<h3>Login with Google</h3>

<div id="buttonDiv"></div>


@code {
    private string? _clientId;
    private static string? authHeader;
    
    [JSInvokable]
    public async Task HandleGoogleSignIn(string idToken)
    {
        Console.WriteLine($"Received ID Token: {idToken}");
        try
        {
            var response = await Http.PostAsJsonAsync("http://localhost/api/members/GoogleCallback", idToken);

            if (response.IsSuccessStatusCode)
            {
                Console.WriteLine("Login successful!");
                var user = await response.Content.ReadFromJsonAsync<MemberDTO>();
                Console.WriteLine($"User logged in: {user?.UserName}");
                
                // Extract the Authorization header
                if (response.Headers.TryGetValues("Authorization", out var authHeaders))
                {
                    authHeader = authHeaders.FirstOrDefault();
                    Console.WriteLine($"Authorization header: {authHeader}");

                    // Set the token in the default request headers for future requests
                    if (!string.IsNullOrEmpty(authHeader))
                    {
                        Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", authHeader);
                    }
                }
                
                // redirect eller no

            }
            else
            {
                Console.WriteLine($"Login failed: {response.StatusCode}");
                var error = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error message: {error}");

            }
        }
        catch (Exception e)
        {
            Console.WriteLine($"An error occurred: {e}");
        }
    }

    protected override async Task OnInitializedAsync()
    {
        _clientId = Configuration["Google:ClientId"];

    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("initGoogleSignIn", _clientId, DotNetObjectReference.Create(this));
        }
    }
}